name: Gitleaks

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Run Gitleaks (JSON)
        run: |
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            ghcr.io/gitleaks/gitleaks:latest \
            detect --source=/workspace --verbose --redact --report-path=/workspace/gitleaks-results.json --report-format=json --exit-code=0

      - name: Run Gitleaks (SARIF)
        if: always()
        run: |
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            ghcr.io/gitleaks/gitleaks:latest \
            detect --source=/workspace --verbose --redact --report-path=/workspace/gitleaks-results.sarif --report-format=sarif --exit-code=0

      - name: Upload Gitleaks SARIF to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gitleaks-results.sarif

      - name: Upload Gitleaks results artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-results
          path: gitleaks-results.json
          retention-days: 30
